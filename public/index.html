<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Reldo Query Explorer</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ”®</text></svg>">
  <script src="https://cdn.jsdelivr.net/npm/ethers@6.9.0/dist/ethers.umd.min.js"></script>
  <style>
    :root {
      --bg: #0a0a0b;
      --card: #141416;
      --border: #27272a;
      --text: #fafafa;
      --muted: #71717a;
      --accent: #3b82f6;
      --green: #22c55e;
      --red: #ef4444;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.6;
      min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; padding: 2rem; }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid var(--border);
    }
    .logo { display: flex; align-items: center; gap: 0.75rem; }
    .logo span { font-size: 2rem; }
    .logo h1 { font-size: 1.5rem; font-weight: 600; }
    .links { display: flex; align-items: center; gap: 1rem; }
    .links a {
      color: var(--muted);
      text-decoration: none;
      font-size: 0.9rem;
    }
    .links a:hover { color: var(--text); }
    
    /* Query Section */
    .query-section {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 1.5rem;
      margin-bottom: 2rem;
    }
    .query-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    .query-header h2 {
      font-size: 1.1rem;
      font-weight: 600;
    }
    .connect-btn, .ask-btn {
      background: var(--accent);
      color: white;
      border: none;
      padding: 0.6rem 1.2rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      font-weight: 500;
    }
    .connect-btn:hover, .ask-btn:hover {
      opacity: 0.9;
    }
    .connect-btn:disabled, .ask-btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .connect-btn.connected {
      background: var(--green);
    }
    .query-form {
      display: flex;
      gap: 1rem;
      align-items: flex-end;
      flex-wrap: wrap;
    }
    .form-group {
      flex: 1;
      min-width: 200px;
    }
    .form-group label {
      display: block;
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
    }
    .form-group select {
      width: 100%;
      padding: 0.75rem;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text);
      font-size: 0.9rem;
    }
    .price-tag {
      background: rgba(34, 197, 94, 0.15);
      color: var(--green);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      font-size: 0.85rem;
      font-weight: 500;
    }
    .result-box {
      margin-top: 1rem;
      padding: 1rem;
      background: var(--bg);
      border-radius: 8px;
      display: none;
    }
    .result-box.visible { display: block; }
    .result-box.error { border: 1px solid var(--red); }
    .result-box.success { border: 1px solid var(--green); }
    .result-box pre {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 0.8rem;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .result-label {
      font-size: 0.75rem;
      color: var(--muted);
      margin-bottom: 0.5rem;
      text-transform: uppercase;
    }
    .wallet-info {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .network-warning {
      background: rgba(234, 179, 8, 0.15);
      color: #eab308;
      padding: 0.75rem 1rem;
      border-radius: 6px;
      font-size: 0.85rem;
      margin-top: 1rem;
      display: none;
    }
    .network-warning.visible { display: block; }

    /* Stats */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 1rem;
      margin-bottom: 2rem;
    }
    .stat-card {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      padding: 1.25rem;
    }
    .stat-card .label { color: var(--muted); font-size: 0.85rem; margin-bottom: 0.25rem; }
    .stat-card .value { font-size: 1.75rem; font-weight: 600; }
    .stat-card .value.green { color: var(--green); }

    /* Filters & Table */
    .filters {
      display: flex;
      gap: 0.75rem;
      margin-bottom: 1rem;
      flex-wrap: wrap;
    }
    .filter-btn {
      background: var(--card);
      border: 1px solid var(--border);
      color: var(--text);
      padding: 0.5rem 1rem;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.85rem;
    }
    .filter-btn:hover, .filter-btn.active {
      border-color: var(--accent);
      color: var(--accent);
    }
    .queries-table {
      background: var(--card);
      border: 1px solid var(--border);
      border-radius: 8px;
      overflow: hidden;
    }
    table { width: 100%; border-collapse: collapse; }
    th {
      text-align: left;
      padding: 1rem;
      background: rgba(255,255,255,0.02);
      font-weight: 500;
      font-size: 0.85rem;
      color: var(--muted);
      border-bottom: 1px solid var(--border);
    }
    td {
      padding: 1rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }
    tr:last-child td { border-bottom: none; }
    tr:hover { background: rgba(255,255,255,0.02); }
    .type-badge {
      display: inline-block;
      padding: 0.25rem 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      font-weight: 500;
      background: rgba(59, 130, 246, 0.15);
      color: var(--accent);
    }
    .type-badge.gas { background: rgba(234, 179, 8, 0.15); color: #eab308; }
    .type-badge.block { background: rgba(168, 85, 247, 0.15); color: #a855f7; }
    .type-badge.network { background: rgba(34, 197, 94, 0.15); color: #22c55e; }
    .type-badge.validators { background: rgba(236, 72, 153, 0.15); color: #ec4899; }
    .type-badge.mev { background: rgba(249, 115, 22, 0.15); color: #f97316; }
    .address {
      font-family: 'SF Mono', Monaco, monospace;
      font-size: 0.8rem;
      color: var(--muted);
    }
    .address a { color: var(--accent); text-decoration: none; }
    .address a:hover { text-decoration: underline; }
    .amount { color: var(--green); font-weight: 500; }
    .timestamp { color: var(--muted); font-size: 0.85rem; }
    .response-preview {
      max-width: 300px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
      color: var(--muted);
      font-size: 0.8rem;
    }
    .loading { text-align: center; padding: 3rem; color: var(--muted); }
    .empty { text-align: center; padding: 3rem; color: var(--muted); }

    @media (max-width: 768px) {
      .container { padding: 1rem; }
      header { flex-direction: column; gap: 1rem; text-align: center; }
      .query-form { flex-direction: column; }
      .form-group { width: 100%; }
      table { font-size: 0.8rem; }
      th, td { padding: 0.75rem 0.5rem; }
      .response-preview { display: none; }
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">
        <span>ðŸ”®</span>
        <h1>Reldo Query Explorer</h1>
      </div>
      <div class="links">
        <a href="https://reldo-x402-api.reldo.workers.dev/health" target="_blank">API</a>
        <a href="https://reldo-x402-api.reldo.workers.dev/.well-known/agent-card.json" target="_blank">Agent Card</a>
        <a href="https://x.com/ReldoTheScribe" target="_blank">Twitter</a>
        <a href="https://basescan.org/address/0x62E6D3914c8e211dc27A27080B6eCf283979D60d" target="_blank">Wallet</a>
      </div>
    </header>

    <!-- Query Interface -->
    <div class="query-section">
      <div class="query-header">
        <h2>Ask Reldo</h2>
        <button class="connect-btn" id="connect-btn">Connect Wallet</button>
      </div>
      <div class="wallet-info" id="wallet-info"></div>
      
      <div class="query-form">
        <div class="form-group">
          <label>Query Type</label>
          <select id="query-type">
            <option value="gas">Gas Price</option>
            <option value="block">Latest Block</option>
            <option value="network">Network Status</option>
            <option value="validators">Validator Stats</option>
            <option value="mev">MEV Activity</option>
          </select>
        </div>
        <div class="price-tag">$0.01 USDC</div>
        <button class="ask-btn" id="ask-btn" disabled>Ask (Pay & Query)</button>
      </div>

      <div class="network-warning" id="network-warning">
        Please switch to Base network to make queries.
        <button onclick="switchToBase()" style="margin-left: 1rem; padding: 0.25rem 0.5rem; cursor: pointer;">Switch Network</button>
      </div>

      <div class="result-box" id="result-box">
        <div class="result-label">Result</div>
        <pre id="result-content"></pre>
      </div>
    </div>

    <div class="stats-grid" id="stats">
      <div class="stat-card">
        <div class="label">Total Queries</div>
        <div class="value" id="total-queries">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Last 24 Hours</div>
        <div class="value" id="queries-24h">-</div>
      </div>
      <div class="stat-card">
        <div class="label">Total Earned</div>
        <div class="value green" id="total-earned">-</div>
      </div>
      <div class="stat-card">
        <div class="label">EIP-8004 Token</div>
        <div class="value">#22793</div>
      </div>
    </div>

    <div class="filters">
      <button class="filter-btn active" data-type="">All</button>
      <button class="filter-btn" data-type="gas">Gas</button>
      <button class="filter-btn" data-type="block">Block</button>
      <button class="filter-btn" data-type="network">Network</button>
      <button class="filter-btn" data-type="validators">Validators</button>
      <button class="filter-btn" data-type="mev">MEV</button>
    </div>

    <div class="queries-table">
      <table>
        <thead>
          <tr>
            <th>Time</th>
            <th>Type</th>
            <th>Client</th>
            <th>Amount</th>
            <th>Response</th>
          </tr>
        </thead>
        <tbody id="queries-body">
          <tr><td colspan="5" class="loading">Loading queries...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <script>
    const API_BASE = 'https://reldo-x402-api.reldo.workers.dev';
    const RELDO_ADDRESS = '0x62E6D3914c8e211dc27A27080B6eCf283979D60d';
    const USDC_BASE = '0x833589fCD6eDb6E08f4c7C32D4f71b54bdA02913';
    const BASE_CHAIN_ID = 8453;
    const PAYMENT_AMOUNT = '10000'; // $0.01 = 10000 (6 decimals)

    let provider = null;
    let signer = null;
    let userAddress = null;
    let currentType = '';

    // Wallet Connection
    async function connectWallet() {
      if (!window.ethereum) {
        alert('Please install a wallet like MetaMask or Rabby');
        return;
      }

      try {
        provider = new ethers.BrowserProvider(window.ethereum);
        const accounts = await provider.send('eth_requestAccounts', []);
        userAddress = accounts[0];
        signer = await provider.getSigner();

        const network = await provider.getNetwork();
        updateWalletUI(network.chainId);

        // Listen for network changes
        window.ethereum.on('chainChanged', () => window.location.reload());
        window.ethereum.on('accountsChanged', () => window.location.reload());
      } catch (e) {
        console.error('Connection failed:', e);
        alert('Failed to connect wallet');
      }
    }

    function updateWalletUI(chainId) {
      const connectBtn = document.getElementById('connect-btn');
      const askBtn = document.getElementById('ask-btn');
      const walletInfo = document.getElementById('wallet-info');
      const networkWarning = document.getElementById('network-warning');

      connectBtn.textContent = userAddress.slice(0, 6) + '...' + userAddress.slice(-4);
      connectBtn.classList.add('connected');
      walletInfo.textContent = `Connected: ${userAddress}`;

      if (BigInt(chainId) !== BigInt(BASE_CHAIN_ID)) {
        networkWarning.classList.add('visible');
        askBtn.disabled = true;
      } else {
        networkWarning.classList.remove('visible');
        askBtn.disabled = false;
      }
    }

    async function switchToBase() {
      try {
        await window.ethereum.request({
          method: 'wallet_switchEthereumChain',
          params: [{ chainId: '0x2105' }]
        });
      } catch (e) {
        if (e.code === 4902) {
          await window.ethereum.request({
            method: 'wallet_addEthereumChain',
            params: [{
              chainId: '0x2105',
              chainName: 'Base',
              nativeCurrency: { name: 'ETH', symbol: 'ETH', decimals: 18 },
              rpcUrls: ['https://mainnet.base.org'],
              blockExplorerUrls: ['https://basescan.org']
            }]
          });
        }
      }
    }

    // EIP-3009 transferWithAuthorization signing
    async function signPaymentAuthorization() {
      const validAfter = 0;
      const validBefore = Math.floor(Date.now() / 1000) + 3600; // 1 hour
      const nonce = ethers.hexlify(ethers.randomBytes(32));

      const domain = {
        name: 'USD Coin',
        version: '2',
        chainId: BASE_CHAIN_ID,
        verifyingContract: USDC_BASE
      };

      const types = {
        TransferWithAuthorization: [
          { name: 'from', type: 'address' },
          { name: 'to', type: 'address' },
          { name: 'value', type: 'uint256' },
          { name: 'validAfter', type: 'uint256' },
          { name: 'validBefore', type: 'uint256' },
          { name: 'nonce', type: 'bytes32' }
        ]
      };

      const value = {
        from: userAddress,
        to: RELDO_ADDRESS,
        value: PAYMENT_AMOUNT,
        validAfter: validAfter,
        validBefore: validBefore,
        nonce: nonce
      };

      const signature = await signer.signTypedData(domain, types, value);

      return {
        signature,
        authorization: {
          from: userAddress,
          to: RELDO_ADDRESS,
          value: PAYMENT_AMOUNT,
          validAfter: String(validAfter),
          validBefore: String(validBefore),
          nonce: nonce
        }
      };
    }

    async function askReldo() {
      const askBtn = document.getElementById('ask-btn');
      const resultBox = document.getElementById('result-box');
      const resultContent = document.getElementById('result-content');
      const queryType = document.getElementById('query-type').value;

      askBtn.disabled = true;
      askBtn.textContent = 'Signing...';
      resultBox.className = 'result-box';
      resultBox.classList.add('visible');
      resultContent.textContent = 'Waiting for signature...';

      try {
        // Sign the payment authorization
        const { signature, authorization } = await signPaymentAuthorization();
        
        askBtn.textContent = 'Querying...';
        resultContent.textContent = 'Payment signed. Sending query...';

        // Build x402 payment payload
        const paymentPayload = {
          x402Version: 1,
          scheme: 'exact',
          network: 'base-mainnet',
          payload: {
            signature,
            authorization
          }
        };

        // Send to API
        const response = await fetch(`${API_BASE}/v1/query`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-Payment': btoa(JSON.stringify(paymentPayload))
          },
          body: JSON.stringify({ type: queryType })
        });

        const data = await response.json();

        if (data.success) {
          resultBox.classList.add('success');
          resultContent.textContent = JSON.stringify(data.result, null, 2);
          loadStats();
          loadQueries(currentType);
        } else {
          resultBox.classList.add('error');
          resultContent.textContent = JSON.stringify(data, null, 2);
        }
      } catch (e) {
        resultBox.classList.add('error');
        resultContent.textContent = 'Error: ' + (e.message || e);
      } finally {
        askBtn.disabled = false;
        askBtn.textContent = 'Ask (Pay & Query)';
      }
    }

    // Event listeners
    document.getElementById('connect-btn').addEventListener('click', connectWallet);
    document.getElementById('ask-btn').addEventListener('click', askReldo);

    // Explorer functions
    function formatTime(isoString) {
      const date = new Date(isoString);
      const now = new Date();
      const diff = now - date;
      if (diff < 60000) return 'Just now';
      if (diff < 3600000) return Math.floor(diff / 60000) + 'm ago';
      if (diff < 86400000) return Math.floor(diff / 3600000) + 'h ago';
      return date.toLocaleDateString();
    }

    function truncateAddress(addr) {
      if (!addr) return '-';
      return addr.slice(0, 6) + '...' + addr.slice(-4);
    }

    async function loadStats() {
      try {
        const res = await fetch(`${API_BASE}/v1/stats`);
        const data = await res.json();
        if (data.success) {
          document.getElementById('total-queries').textContent = data.stats.totalQueries;
          document.getElementById('queries-24h').textContent = data.stats.queriesLast24h;
          document.getElementById('total-earned').textContent = data.stats.totalEarnings;
        }
      } catch (e) {
        console.error('Failed to load stats:', e);
      }
    }

    async function loadQueries(type = '') {
      const tbody = document.getElementById('queries-body');
      tbody.innerHTML = '<tr><td colspan="5" class="loading">Loading...</td></tr>';

      try {
        const url = type ? `${API_BASE}/v1/logs?type=${type}&limit=50` : `${API_BASE}/v1/logs?limit=50`;
        const res = await fetch(url);
        const data = await res.json();

        if (!data.success || !data.logs.length) {
          tbody.innerHTML = '<tr><td colspan="5" class="empty">No queries yet. Be the first!</td></tr>';
          return;
        }

        tbody.innerHTML = data.logs.map(q => `
          <tr>
            <td class="timestamp">${formatTime(q.timestamp)}</td>
            <td><span class="type-badge ${q.query_type}">${q.query_type}</span></td>
            <td class="address">
              ${q.client_address ? `<a href="https://basescan.org/address/${q.client_address}" target="_blank">${truncateAddress(q.client_address)}</a>` : '-'}
            </td>
            <td class="amount">${q.amount_usdc ? '$' + parseFloat(q.amount_usdc).toFixed(2) : '-'}</td>
            <td class="response-preview">${q.response_summary || '-'}</td>
          </tr>
        `).join('');
      } catch (e) {
        tbody.innerHTML = '<tr><td colspan="5" class="empty">Failed to load queries</td></tr>';
      }
    }

    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentType = btn.dataset.type;
        loadQueries(currentType);
      });
    });

    // Initial load
    loadStats();
    loadQueries();
    setInterval(() => {
      loadStats();
      loadQueries(currentType);
    }, 30000);

    // Auto-connect if already connected
    if (window.ethereum?.selectedAddress) {
      connectWallet();
    }
  </script>
</body>
</html>
